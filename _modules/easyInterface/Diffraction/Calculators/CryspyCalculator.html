

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>easyInterface.Diffraction.Calculators.CryspyCalculator &mdash; easyInterface 0.0.5 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/theme_override.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> easyInterface
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Example galleries</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../auto_examples/index.html">Introduction to  easyInterface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../auto_examples/index.html#scripted-examples">Scripted Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">API and developer reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer.html">Interface and Calculators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer.html#container-classes">Container Classes</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/easyDiffraction/easyInterface">Fork easyInterface on Github</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">easyInterface</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>easyInterface.Diffraction.Calculators.CryspyCalculator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for easyInterface.Diffraction.Calculators.CryspyCalculator</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">cryspy</span>
<span class="kn">import</span> <span class="nn">pycifstar</span>

<span class="kn">from</span> <span class="nn">asteval</span> <span class="kn">import</span> <span class="n">Interpreter</span>

<span class="kn">from</span> <span class="nn">easyInterface.Diffraction.DataClasses.DataObj.Calculation</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">easyInterface.Diffraction.DataClasses.DataObj.Experiment</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">easyInterface.Diffraction.DataClasses.PhaseObj.Phase</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">easyInterface.Diffraction.DataClasses.Utils.BaseClasses</span> <span class="kn">import</span> <span class="n">Base</span>

<span class="kn">from</span> <span class="nn">easyInterface.Utils.Helpers</span> <span class="kn">import</span> <span class="n">time_it</span>

<span class="c1"># Imports needed to create a cryspyObj</span>
<span class="kn">from</span> <span class="nn">cryspy.scripts.cl_rhochi</span> <span class="kn">import</span> <span class="n">RhoChi</span>
<span class="kn">from</span> <span class="nn">cryspy.cif_like.cl_crystal</span> <span class="kn">import</span> <span class="n">Crystal</span>
<span class="kn">from</span> <span class="nn">cryspy.cif_like.cl_pd</span> <span class="kn">import</span> <span class="n">Phase</span> <span class="k">as</span> <span class="n">cpPhase</span>
<span class="kn">from</span> <span class="nn">cryspy.cif_like.cl_pd</span> <span class="kn">import</span> <span class="n">Pd</span><span class="p">,</span> <span class="n">PdBackground</span><span class="p">,</span> <span class="n">PdBackgroundL</span><span class="p">,</span> <span class="n">PdInstrResolution</span><span class="p">,</span> <span class="n">PdMeas</span><span class="p">,</span> <span class="n">PdMeasL</span><span class="p">,</span> <span class="n">PhaseL</span><span class="p">,</span> <span class="n">Setup</span>

<span class="c1"># Imports needed to create a phase</span>
<span class="kn">from</span> <span class="nn">cryspy.corecif.cl_cell</span> <span class="kn">import</span> <span class="n">Cell</span> <span class="k">as</span> <span class="n">cpCell</span>
<span class="kn">from</span> <span class="nn">cryspy.corecif.cl_atom_site</span> <span class="kn">import</span> <span class="n">AtomSite</span><span class="p">,</span> <span class="n">AtomSiteL</span>
<span class="kn">from</span> <span class="nn">cryspy.corecif.cl_atom_site_aniso</span> <span class="kn">import</span> <span class="n">AtomSiteAniso</span><span class="p">,</span> <span class="n">AtomSiteAnisoL</span>
<span class="kn">from</span> <span class="nn">cryspy.magneticcif.cl_atom_site_susceptibility</span> <span class="kn">import</span> <span class="n">AtomSiteSusceptibility</span><span class="p">,</span> <span class="n">AtomSiteSusceptibilityL</span>
<span class="kn">from</span> <span class="nn">cryspy.symcif.cl_space_group</span> <span class="kn">import</span> <span class="n">SpaceGroup</span> <span class="k">as</span> <span class="n">cpSpaceGroup</span>

<span class="kn">from</span> <span class="nn">easyInterface</span> <span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">logging</span>

<span class="n">PHASE_SEGMENT</span> <span class="o">=</span> <span class="s2">&quot;_phases&quot;</span>
<span class="n">EXPERIMENT_SEGMENT</span> <span class="o">=</span> <span class="s2">&quot;_experiments&quot;</span>

<span class="n">CALCULATOR_INFO</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;CrysPy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;0.2.0&#39;</span><span class="p">,</span>
    <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://github.com/ikibalin/cryspy&#39;</span>
<span class="p">}</span>


<div class="viewcode-block" id="CryspyCalculator"><a class="viewcode-back" href="../../../../calculators.html#easyInterface.Diffraction.Calculators.CryspyCalculator">[docs]</a><span class="k">class</span> <span class="nc">CryspyCalculator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_rcif_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_rcif_path</span> <span class="o">=</span> <span class="n">main_rcif_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_rcif</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phases_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_experiments_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createCryspyObj</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created cryspy calculator interface&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculatorInfo</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CALCULATOR_INFO</span>

    <span class="nd">@time_it</span>
    <span class="k">def</span> <span class="nf">_createCryspyObj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create cryspy object from separate rcif files</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating cryspy object&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">phase_segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseSegment</span><span class="p">(</span><span class="n">PHASE_SEGMENT</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Main cif location is not a path&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RhoChi</span><span class="p">()</span>
        <span class="n">full_rcif_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseSegment</span><span class="p">(</span><span class="n">EXPERIMENT_SEGMENT</span><span class="p">)</span> <span class="o">+</span> <span class="n">phase_segment</span>
        <span class="c1"># update the phase name global</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calling RhoChi&#39;</span><span class="p">)</span>
        <span class="n">rho_chi</span> <span class="o">=</span> <span class="n">RhoChi</span><span class="p">()</span><span class="o">.</span><span class="n">from_cif</span><span class="p">(</span><span class="n">full_rcif_content</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rho_chi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Main CIF is empty&#39;</span><span class="p">)</span>
            <span class="n">rho_chi</span> <span class="o">=</span> <span class="n">RhoChi</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Populating _phase_name with cryspy phase names&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="o">.</span><span class="n">data_name</span> <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">rho_chi</span><span class="o">.</span><span class="n">crystals</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_name</span> <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">rho_chi</span><span class="o">.</span><span class="n">experiments</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rho_chi</span>

    <span class="k">def</span> <span class="nf">_parseSegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the given segment info from the main rcif file</span>
<span class="sd">        :param segment:</span>
<span class="sd">        :return: Parsed cif file content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading main cif file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">segment</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;segment is empty&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">segment</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">PHASE_SEGMENT</span><span class="p">,</span> <span class="n">EXPERIMENT_SEGMENT</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;segment not in phase or experiment&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">rcif_dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_main_rcif_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_main_rcif</span> <span class="o">=</span> <span class="n">pycifstar</span><span class="o">.</span><span class="n">read_star_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_main_rcif_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Main cif can not be found&#39;</span><span class="p">)</span>
        <span class="n">rcif_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_main_rcif</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;segment in main cif&#39;</span><span class="p">)</span>
            <span class="n">segment_rcif_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rcif_dir_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_rcif</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">segment_rcif_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">segment_rcif_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Reading cif segment&#39;</span><span class="p">)</span>
                    <span class="n">segment_rcif_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">rcif_content</span> <span class="o">+=</span> <span class="n">segment_rcif_content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rcif_content</span>

    <span class="k">def</span> <span class="nf">setExpsDefinition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cryspy.experiments from a single file. *Removes all others*</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rcif_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Experiment definition is not a string or path&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># This will read the CIF file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">exp_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">exp_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Reading experiment cif file&#39;</span><span class="p">)</span>
                <span class="n">exp_rcif_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">rcif_content</span> <span class="o">+=</span> <span class="n">exp_rcif_content</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_experiments_path</span> <span class="o">=</span> <span class="n">exp_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Experiment cif can not be found&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">experiment</span> <span class="o">=</span> <span class="n">Pd</span><span class="o">.</span><span class="n">from_cif</span><span class="p">(</span><span class="n">exp_rcif_content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">experiment</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_name</span> <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting cryspy experiments from cif content&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addExpsDefinition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an experiment to cryspy.experiments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Experiment definition is not a string or path&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">exp_rcif_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># This will read the CIF file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">exp_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">exp_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Reading cif content for experiment definition&#39;</span><span class="p">)</span>
                <span class="n">exp_rcif_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_experiments_path</span> <span class="o">=</span> <span class="n">exp_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Experiment cif can not be found&#39;</span><span class="p">)</span>

        <span class="n">experiment</span> <span class="o">=</span> <span class="n">Pd</span><span class="o">.</span><span class="n">from_cif</span><span class="p">(</span><span class="n">exp_rcif_content</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding experiment to cryspy experiments&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="n">experiment</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Experiment set from cif content&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">experiment</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting Experiment to be the pattern for the first phase&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_name</span> <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">removeExpsDefinition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Experiment found, removing&#39;</span><span class="p">)</span>
            <span class="n">experiments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">experiment</span> <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">experiments</span> <span class="k">if</span> <span class="n">experiment</span><span class="o">.</span><span class="n">data_name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_name</span> <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setPhaseDefinition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phases_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the relevant phases file and update the corresponding model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rcif_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Phase definition is not a string or path&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># This will read the CIF file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">phases_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">phases_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">phases_rcif_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">rcif_content</span> <span class="o">+=</span> <span class="n">phases_rcif_content</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phases_path</span> <span class="o">=</span> <span class="n">phases_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Phase cif can not be found&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># find the name of the new phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting phase to cryspy crystals&#39;</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">Crystal</span><span class="p">()</span><span class="o">.</span><span class="n">from_cif</span><span class="p">(</span><span class="n">phases_rcif_content</span><span class="p">)</span>
        <span class="n">new_phase_name</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">data_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="o">.</span><span class="n">data_name</span> <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">]</span>

        <span class="n">experiment_segment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="p">,</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">cl_rhochi</span><span class="o">.</span><span class="n">RhoChi</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># TODO note only the first exp</span>
                <span class="n">experiment_segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_cif</span><span class="p">()</span>
                <span class="c1"># Concatenate the corrected experiment and the new CIF</span>
                <span class="n">rcif_content</span> <span class="o">=</span> <span class="n">rcif_content</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">experiment_segment</span>
                <span class="c1"># This will update the CrysPy object</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">from_cif</span><span class="p">(</span><span class="n">rcif_content</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting phase to existing experiment&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">associatePhaseToExp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span> <span class="n">new_phase_name</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="c1"># self._cryspy_obj.experiments[0].phase.items[0] = (new_phase_name)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addPhaseDefinition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phases_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the relevant phases file and update the corresponding model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Phase definition is not a string or path&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">phases_rcif_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># This will read the CIF file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">phases_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">phases_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">phases_rcif_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phases_path</span> <span class="o">=</span> <span class="n">phases_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Phase cif can not be found&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># find the name of the new phase</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">Crystal</span><span class="p">()</span><span class="o">.</span><span class="n">from_cif</span><span class="p">(</span><span class="n">phases_rcif_content</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding phase to existing phases&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">,</span> <span class="n">phase</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting cryspy crystal to phase&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="o">.</span><span class="n">data_name</span> <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">removePhaseDefinition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">:</span>
            <span class="n">crystals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="o">=</span> <span class="p">[</span><span class="n">crystal</span> <span class="k">for</span> <span class="n">crystal</span> <span class="ow">in</span> <span class="n">crystals</span> <span class="k">if</span> <span class="n">crystal</span><span class="o">.</span><span class="n">data_name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="o">.</span><span class="n">data_name</span> <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing phase </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Phase not found in cryspy crystals&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span>
        <span class="c1"># See if this is associated to an experiment....</span>
        <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPhasesAssocatedToExp</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disassociatePhaseToExp</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">writeMainCif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;main.cif&#39;</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;experiments.cif&#39;</span><span class="p">,</span>
                     <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;phases.cif&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing main cif file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="p">,</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">cl_rhochi</span><span class="o">.</span><span class="n">RhoChi</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cryspy object is malformed. Failure...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">main_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_rcif</span>
        <span class="n">save_to</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">main_block</span><span class="p">[</span><span class="s2">&quot;_phases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">phase_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">main_block</span><span class="p">[</span><span class="s2">&quot;_experiments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">exp_name</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">main_block</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">save_to</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No permission to write to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">save_to</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">writePhaseCif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;phases.cif&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>
        <span class="n">save_to</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="p">,</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">cl_rhochi</span><span class="o">.</span><span class="n">RhoChi</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cryspy object is malformed. Failure...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">phases_block</span> <span class="o">=</span> <span class="n">pycifstar</span><span class="o">.</span><span class="n">Global</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing phase cif files&#39;</span><span class="p">)</span>
            <span class="n">phase_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">crystal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">:</span>
                <span class="n">phase_str</span> <span class="o">+</span> <span class="n">crystal</span><span class="o">.</span><span class="n">to_cif</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">phases_block</span><span class="o">.</span><span class="n">take_from_string</span><span class="p">(</span><span class="n">phase_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No experiments to save. creating empty file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">save_to</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">phases_block</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">save_to</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No permission to write to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">save_to</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">writeExpCif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;experiments.cif&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="p">,</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">cl_rhochi</span><span class="o">.</span><span class="n">RhoChi</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cryspy object is malformed. Failure...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">save_to</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">)</span>
        <span class="n">exp_block</span> <span class="o">=</span> <span class="n">pycifstar</span><span class="o">.</span><span class="n">Global</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exp_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
                <span class="n">exp_str</span> <span class="o">+</span> <span class="n">experiment</span><span class="o">.</span><span class="n">to_cif</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">exp_block</span><span class="o">.</span><span class="n">take_from_string</span><span class="p">(</span><span class="n">exp_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No experiments to save. creating empty file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">save_to</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exp_block</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">save_to</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No permission to write to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">save_to</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">saveCifs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;main.cif&#39;</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;experiments.cif&#39;</span><span class="p">,</span>
                 <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;phases.cif&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeMainCif</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writePhaseCif</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeExpCif</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cifs saved successfully&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to save cifs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_createProjItemFromObj</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">obj_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; ... &quot;&quot;&quot;</span>
        <span class="n">ret_vals</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">cl_fitable</span><span class="o">.</span><span class="n">Fitable</span><span class="p">)</span> <span class="k">else</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj_list</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_list</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">cl_fitable</span><span class="o">.</span><span class="n">Fitable</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret_vals</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Base</span><span class="p">):</span>
                <span class="n">ret_vals</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">],</span> <span class="n">obj_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>
                <span class="n">ret_vals</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;constraint&#39;</span><span class="p">],</span> <span class="n">obj_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">constraint</span><span class="p">)</span>
                <span class="n">ret_vals</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;hide&#39;</span><span class="p">],</span> <span class="n">obj_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">constraint_flag</span><span class="p">)</span>
                <span class="n">ret_vals</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;refine&#39;</span><span class="p">],</span> <span class="n">obj_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">refinement</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret_vals</span>

<div class="viewcode-block" id="CryspyCalculator.getPhases"><a class="viewcode-back" href="../../../../calculators.html#easyInterface.Diffraction.Calculators.CryspyCalculator.getPhases">[docs]</a>    <span class="nd">@time_it</span>
    <span class="k">def</span> <span class="nf">getPhases</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Phases</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set phases (sample model tab in GUI)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="p">,</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">cl_rhochi</span><span class="o">.</span><span class="n">RhoChi</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Phases</span><span class="p">({})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">apply_constraint</span><span class="p">()</span>  <span class="c1"># THIS IS 400ms !!!!!!</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_makePhase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">))</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phases</span></div>

    <span class="k">def</span> <span class="nf">readPhaseDefinition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phases_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----&gt; Start&#39;</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the relevant phases file and update the corresponding model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phases_rcif_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Phase definition is not a string or path&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># This will read the CIF file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">phases_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">phases_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">phases_rcif_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">phase_cp</span> <span class="o">=</span> <span class="n">cpPhase</span><span class="p">()</span><span class="o">.</span><span class="n">from_cif</span><span class="p">(</span><span class="n">phases_rcif_content</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makePhase</span><span class="p">(</span><span class="n">phase_cp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&lt;---- End&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phase</span><span class="p">,</span> <span class="n">phase_cp</span>

    <span class="k">def</span> <span class="nf">_makePhase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calculator_phase</span><span class="p">:</span> <span class="n">Crystal</span><span class="p">):</span>
        <span class="c1"># This is ~180ms per atom in phase. Limited by cryspy </span>
        <span class="n">calculator_phase_name</span> <span class="o">=</span> <span class="n">calculator_phase</span><span class="o">.</span><span class="n">data_name</span>
        <span class="c1"># This group is &lt; 1ms</span>
        <span class="n">space_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPhasesSpace_group</span><span class="p">(</span><span class="n">calculator_phase_name</span><span class="p">)</span>
        <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPhaseCell</span><span class="p">(</span><span class="n">calculator_phase_name</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">Phase</span><span class="o">.</span><span class="n">fromPars</span><span class="p">(</span><span class="n">calculator_phase_name</span><span class="p">,</span> <span class="n">space_group</span><span class="p">,</span> <span class="n">unit_cell</span><span class="p">)</span>
        <span class="c1"># Atom sites ~ 6ms</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeAtom</span><span class="p">(</span><span class="n">calculator_phase</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;atoms&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># This is ~125ms per atom due to cryspy taking ~110ms :-(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_makeAtomSites</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">calculator_phase</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phase</span>

    <span class="k">def</span> <span class="nf">_makeAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calculator_phase</span><span class="p">:</span> <span class="n">Crystal</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># This is ~2ms</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">calculator_atom_site</span> <span class="o">=</span> <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">calculator_phase</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># Phase has not been added to crystal. Assume that it will be, possibly in error :-/</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># There are no crystals yet. assume that it will be added.</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>  
        <span class="n">mapping_base</span> <span class="o">=</span> <span class="s1">&#39;self._cryspy_obj.crystals&#39;</span>
        <span class="n">mapping_phase</span> <span class="o">=</span> <span class="n">mapping_base</span> <span class="o">+</span> <span class="s1">&#39;[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="n">mapping_atom</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.atom_site&#39;</span>

        <span class="c1"># Atom sites symbol</span>
        <span class="n">type_symbol</span> <span class="o">=</span> <span class="n">calculator_atom_site</span><span class="o">.</span><span class="n">type_symbol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Atom site neutron scattering length</span>
        <span class="n">scat_length_neutron</span> <span class="o">=</span> <span class="n">calculator_atom_site</span><span class="o">.</span><span class="n">scat_length_neutron</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Atom site coordinates</span>
        <span class="n">fract_x</span> <span class="o">=</span> <span class="n">calculator_atom_site</span><span class="o">.</span><span class="n">fract_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fract_y</span> <span class="o">=</span> <span class="n">calculator_atom_site</span><span class="o">.</span><span class="n">fract_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fract_z</span> <span class="o">=</span> <span class="n">calculator_atom_site</span><span class="o">.</span><span class="n">fract_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Atom site occupancy</span>
        <span class="n">occupancy</span> <span class="o">=</span> <span class="n">calculator_atom_site</span><span class="o">.</span><span class="n">occupancy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Atom site ADP type</span>
        <span class="n">adp_type</span> <span class="o">=</span> <span class="n">calculator_atom_site</span><span class="o">.</span><span class="n">adp_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Atom site isotropic ADP</span>
        <span class="n">U_iso_or_equiv</span> <span class="o">=</span> <span class="n">calculator_atom_site</span><span class="o">.</span><span class="n">u_iso_or_equiv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Atom site anisotropic ADP</span>
        <span class="n">adp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_aniso</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_aniso</span><span class="o">.</span><span class="n">u_11</span><span class="p">):</span>
                <span class="n">mapping_adp</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.atom_site_aniso&#39;</span>

                <span class="n">adp</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_aniso</span><span class="o">.</span><span class="n">u_11</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_aniso</span><span class="o">.</span><span class="n">u_22</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_aniso</span><span class="o">.</span><span class="n">u_33</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_aniso</span><span class="o">.</span><span class="n">u_12</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_aniso</span><span class="o">.</span><span class="n">u_13</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_aniso</span><span class="o">.</span><span class="n">u_23</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">adp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createProjItemFromObj</span><span class="p">(</span><span class="n">ADP</span><span class="o">.</span><span class="n">fromPars</span><span class="p">,</span>
                                                  <span class="p">[</span><span class="s1">&#39;u_11&#39;</span><span class="p">,</span> <span class="s1">&#39;u_22&#39;</span><span class="p">,</span> <span class="s1">&#39;u_33&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;u_12&#39;</span><span class="p">,</span> <span class="s1">&#39;u_13&#39;</span><span class="p">,</span> <span class="s1">&#39;u_23&#39;</span><span class="p">],</span>
                                                  <span class="n">adp</span><span class="p">)</span>
                <span class="n">adp</span><span class="p">[</span><span class="s1">&#39;u_11&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_adp</span> <span class="o">+</span> <span class="s1">&#39;.u_11[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">adp</span><span class="p">[</span><span class="s1">&#39;u_22&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_adp</span> <span class="o">+</span> <span class="s1">&#39;.u_22[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">adp</span><span class="p">[</span><span class="s1">&#39;u_33&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_adp</span> <span class="o">+</span> <span class="s1">&#39;.u_33[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">adp</span><span class="p">[</span><span class="s1">&#39;u_12&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_adp</span> <span class="o">+</span> <span class="s1">&#39;.u_12[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">adp</span><span class="p">[</span><span class="s1">&#39;u_13&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_adp</span> <span class="o">+</span> <span class="s1">&#39;.u_13[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">adp</span><span class="p">[</span><span class="s1">&#39;u_23&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_adp</span> <span class="o">+</span> <span class="s1">&#39;.u_23[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Atom site MSP</span>
        <span class="n">msp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_susceptibility</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_susceptibility</span><span class="o">.</span><span class="n">chi_type</span><span class="p">):</span>
                <span class="n">mapping_msp</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.atom_site_susceptibility&#39;</span>

                <span class="n">msp</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_susceptibility</span><span class="o">.</span><span class="n">chi_type</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_susceptibility</span><span class="o">.</span><span class="n">chi_11</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_susceptibility</span><span class="o">.</span><span class="n">chi_22</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_susceptibility</span><span class="o">.</span><span class="n">chi_33</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_susceptibility</span><span class="o">.</span><span class="n">chi_12</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_susceptibility</span><span class="o">.</span><span class="n">chi_13</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site_susceptibility</span><span class="o">.</span><span class="n">chi_23</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">msp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createProjItemFromObj</span><span class="p">(</span><span class="n">MSP</span><span class="o">.</span><span class="n">fromPars</span><span class="p">,</span>
                                                  <span class="p">[</span><span class="s1">&#39;MSPtype&#39;</span><span class="p">,</span> <span class="s1">&#39;chi_11&#39;</span><span class="p">,</span> <span class="s1">&#39;chi_22&#39;</span><span class="p">,</span> <span class="s1">&#39;chi_33&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;chi_12&#39;</span><span class="p">,</span> <span class="s1">&#39;chi_13&#39;</span><span class="p">,</span> <span class="s1">&#39;chi_23&#39;</span><span class="p">],</span>
                                                  <span class="n">msp</span><span class="p">)</span>
                <span class="n">msp</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_msp</span> <span class="o">+</span> <span class="s1">&#39;.chi_type[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">msp</span><span class="p">[</span><span class="s1">&#39;chi_11&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_msp</span> <span class="o">+</span> <span class="s1">&#39;.chi_11[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">msp</span><span class="p">[</span><span class="s1">&#39;chi_22&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_msp</span> <span class="o">+</span> <span class="s1">&#39;.chi_22[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">msp</span><span class="p">[</span><span class="s1">&#39;chi_33&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_msp</span> <span class="o">+</span> <span class="s1">&#39;.chi_33[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">msp</span><span class="p">[</span><span class="s1">&#39;chi_12&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_msp</span> <span class="o">+</span> <span class="s1">&#39;.chi_12[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">msp</span><span class="p">[</span><span class="s1">&#39;chi_13&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_msp</span> <span class="o">+</span> <span class="s1">&#39;.chi_13[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">msp</span><span class="p">[</span><span class="s1">&#39;chi_23&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_msp</span> <span class="o">+</span> <span class="s1">&#39;.chi_23[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Add an atom to atoms</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createProjItemFromObj</span><span class="p">(</span>
            <span class="n">Atom</span><span class="o">.</span><span class="n">fromPars</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;atom_site_label&#39;</span><span class="p">,</span> <span class="s1">&#39;type_symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;scat_length_neutron&#39;</span><span class="p">,</span>
             <span class="s1">&#39;fract_x&#39;</span><span class="p">,</span> <span class="s1">&#39;fract_y&#39;</span><span class="p">,</span> <span class="s1">&#39;fract_z&#39;</span><span class="p">,</span> <span class="s1">&#39;occupancy&#39;</span><span class="p">,</span> <span class="s1">&#39;adp_type&#39;</span><span class="p">,</span>
             <span class="s1">&#39;U_iso_or_equiv&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">type_symbol</span><span class="p">,</span> <span class="n">scat_length_neutron</span><span class="p">,</span>
             <span class="n">fract_x</span><span class="p">,</span> <span class="n">fract_y</span><span class="p">,</span> <span class="n">fract_z</span><span class="p">,</span> <span class="n">occupancy</span><span class="p">,</span> <span class="n">adp_type</span><span class="p">,</span>
             <span class="n">U_iso_or_equiv</span><span class="p">,</span> <span class="n">adp</span><span class="p">,</span> <span class="n">msp</span><span class="p">])</span>

        <span class="n">atom</span><span class="p">[</span><span class="s1">&#39;scat_length_neutron&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_atom</span> <span class="o">+</span> <span class="s1">&#39;.scat_length_neutron[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">atom</span><span class="p">[</span><span class="s1">&#39;fract_x&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_atom</span> <span class="o">+</span> <span class="s1">&#39;.fract_x[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">atom</span><span class="p">[</span><span class="s1">&#39;fract_y&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_atom</span> <span class="o">+</span> <span class="s1">&#39;.fract_y[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">atom</span><span class="p">[</span><span class="s1">&#39;fract_z&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_atom</span> <span class="o">+</span> <span class="s1">&#39;.fract_z[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">atom</span><span class="p">[</span><span class="s1">&#39;occupancy&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_atom</span> <span class="o">+</span> <span class="s1">&#39;.occupancy[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">atom</span><span class="p">[</span><span class="s1">&#39;adp_type&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_atom</span> <span class="o">+</span> <span class="s1">&#39;.adp_type[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">atom</span><span class="p">[</span><span class="s1">&#39;U_iso_or_equiv&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_atom</span> <span class="o">+</span> <span class="s1">&#39;.u_iso_or_equiv[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">atom</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_makeAtomSites</span><span class="p">(</span><span class="n">phase</span><span class="p">:</span> <span class="n">Phase</span><span class="p">,</span> <span class="n">calculator_phase</span><span class="p">:</span> <span class="n">Crystal</span><span class="p">):</span>
        <span class="n">atom_site_list</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]]</span>
        <span class="c1"># Atom sites for structure view (all the positions inside unit cell of 1x1x1)</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">scat_length_neutron</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site</span><span class="o">.</span><span class="n">fract_x</span><span class="p">,</span>
                                                <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site</span><span class="o">.</span><span class="n">fract_y</span><span class="p">,</span>
                                                <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site</span><span class="o">.</span><span class="n">fract_z</span><span class="p">,</span>
                                                <span class="n">calculator_phase</span><span class="o">.</span><span class="n">atom_site</span><span class="o">.</span><span class="n">scat_length_neutron</span><span class="p">):</span>
            <span class="n">x_array</span><span class="p">,</span> <span class="n">y_array</span><span class="p">,</span> <span class="n">z_array</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">calculator_phase</span><span class="o">.</span><span class="n">space_group</span><span class="o">.</span><span class="n">calc_xyz_mult</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">scat_length_neutron_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="n">scat_length_neutron</span><span class="p">)</span>
            <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x_array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">y_array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">z_array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">scat_length_neutron_array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">scat_length_neutron</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atom_site_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scat_length_neutron</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scat_length_neutron</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scat_length_neutron</span><span class="p">)</span>

        <span class="n">phase</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="s1">&#39;fract_x&#39;</span><span class="p">],</span> <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">phase</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="s1">&#39;fract_y&#39;</span><span class="p">],</span> <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">phase</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="s1">&#39;fract_z&#39;</span><span class="p">],</span> <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">phase</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="s1">&#39;scat_length_neutron&#39;</span><span class="p">],</span> <span class="n">atom_site_list</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_getPhasesSpace_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpaceGroup</span><span class="p">:</span>
        <span class="n">mapping_base</span> <span class="o">=</span> <span class="s1">&#39;self._cryspy_obj.crystals&#39;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
        <span class="n">calculator_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># logging.info(calculator_phase_name)</span>
        <span class="n">mapping_phase</span> <span class="o">=</span> <span class="n">mapping_base</span> <span class="o">+</span> <span class="s1">&#39;[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># Space group</span>
        <span class="n">space_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createProjItemFromObj</span><span class="p">(</span><span class="n">SpaceGroup</span><span class="o">.</span><span class="n">fromPars</span><span class="p">,</span>
                                                  <span class="p">[</span><span class="s1">&#39;crystal_system&#39;</span><span class="p">,</span> <span class="s1">&#39;space_group_name_HM_alt&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;space_group_IT_number&#39;</span><span class="p">,</span> <span class="s1">&#39;origin_choice&#39;</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="n">calculator_phase</span><span class="o">.</span><span class="n">space_group</span><span class="o">.</span><span class="n">crystal_system</span><span class="p">,</span>
                                                   <span class="n">calculator_phase</span><span class="o">.</span><span class="n">space_group</span><span class="o">.</span><span class="n">name_hm_ref</span><span class="p">,</span>
                                                   <span class="n">calculator_phase</span><span class="o">.</span><span class="n">space_group</span><span class="o">.</span><span class="n">it_number</span><span class="p">,</span>
                                                   <span class="n">calculator_phase</span><span class="o">.</span><span class="n">space_group</span><span class="o">.</span><span class="n">it_coordinate_system_code</span><span class="p">])</span>

        <span class="n">space_group</span><span class="p">[</span><span class="s1">&#39;crystal_system&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.space_group.crystal_system&#39;</span>
        <span class="n">space_group</span><span class="p">[</span><span class="s1">&#39;space_group_name_HM_alt&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.space_group.name_hm_ref&#39;</span>
        <span class="n">space_group</span><span class="p">[</span><span class="s1">&#39;space_group_IT_number&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.space_group.it_number&#39;</span>
        <span class="n">space_group</span><span class="p">[</span><span class="s1">&#39;origin_choice&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.space_group.it_coordinate_system_code&#39;</span>
        <span class="k">return</span> <span class="n">space_group</span>

    <span class="k">def</span> <span class="nf">_getPhaseCell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cell</span><span class="p">:</span>
        <span class="n">mapping_base</span> <span class="o">=</span> <span class="s1">&#39;self._cryspy_obj.crystals&#39;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
        <span class="n">calculator_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># logging.info(calculator_phase_name)</span>
        <span class="n">mapping_phase</span> <span class="o">=</span> <span class="n">mapping_base</span> <span class="o">+</span> <span class="s1">&#39;[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createProjItemFromObj</span><span class="p">(</span><span class="n">Cell</span><span class="o">.</span><span class="n">fromPars</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;length_a&#39;</span><span class="p">,</span> <span class="s1">&#39;length_b&#39;</span><span class="p">,</span> <span class="s1">&#39;length_c&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;angle_alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;angle_beta&#39;</span><span class="p">,</span> <span class="s1">&#39;angle_gamma&#39;</span><span class="p">],</span>
                                                <span class="p">[</span><span class="n">calculator_phase</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">length_a</span><span class="p">,</span> <span class="n">calculator_phase</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">length_b</span><span class="p">,</span>
                                                 <span class="n">calculator_phase</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">length_c</span><span class="p">,</span> <span class="n">calculator_phase</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">angle_alpha</span><span class="p">,</span>
                                                 <span class="n">calculator_phase</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">angle_beta</span><span class="p">,</span>
                                                 <span class="n">calculator_phase</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">angle_gamma</span><span class="p">])</span>

        <span class="n">unit_cell</span><span class="p">[</span><span class="s1">&#39;length_a&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.cell.length_a&#39;</span>
        <span class="n">unit_cell</span><span class="p">[</span><span class="s1">&#39;length_b&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.cell.length_b&#39;</span>
        <span class="n">unit_cell</span><span class="p">[</span><span class="s1">&#39;length_c&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.cell.length_c&#39;</span>
        <span class="n">unit_cell</span><span class="p">[</span><span class="s1">&#39;angle_alpha&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.cell.angle_alpha&#39;</span>
        <span class="n">unit_cell</span><span class="p">[</span><span class="s1">&#39;angle_beta&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.cell.angle_beta&#39;</span>
        <span class="n">unit_cell</span><span class="p">[</span><span class="s1">&#39;angle_gamma&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_phase</span> <span class="o">+</span> <span class="s1">&#39;.cell.angle_gamma&#39;</span>
        <span class="k">return</span> <span class="n">unit_cell</span>

    <span class="nd">@time_it</span>
    <span class="k">def</span> <span class="nf">getExperiments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Experiments</span><span class="p">:</span>
        <span class="n">experiments</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">mapping_base</span> <span class="o">=</span> <span class="s1">&#39;self._cryspy_obj.experiments&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Experiments</span><span class="p">({})</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">calculator_experiment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">):</span>
            <span class="n">calculator_experiment_name</span> <span class="o">=</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">data_name</span>

            <span class="n">mapping_exp</span> <span class="o">=</span> <span class="n">mapping_base</span> <span class="o">+</span> <span class="s1">&#39;[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Experimental setup</span>
            <span class="n">calculator_setup</span> <span class="o">=</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">setup</span>
            <span class="n">wavelength</span> <span class="o">=</span> <span class="n">calculator_setup</span><span class="o">.</span><span class="n">wavelength</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">calculator_setup</span><span class="o">.</span><span class="n">offset_ttheta</span>

            <span class="c1"># Scale</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">scale</span>

            <span class="c1"># Background</span>
            <span class="n">calculator_background</span> <span class="o">=</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">background</span>
            <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">ttheta</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">calculator_background</span><span class="o">.</span><span class="n">ttheta</span><span class="p">,</span> <span class="n">calculator_background</span><span class="o">.</span><span class="n">intensity</span><span class="p">)):</span>
                <span class="n">background</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createProjItemFromObj</span><span class="p">(</span><span class="n">Background</span><span class="o">.</span><span class="n">fromPars</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ttheta&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">],</span>
                                                         <span class="p">[</span><span class="n">ttheta</span><span class="p">,</span> <span class="n">intensity</span><span class="p">])</span>
                <span class="n">background</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_exp</span> <span class="o">+</span> <span class="s1">&#39;.background.intensity[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
            <span class="n">backgrounds</span> <span class="o">=</span> <span class="n">Backgrounds</span><span class="p">(</span><span class="n">backgrounds</span><span class="p">)</span>

            <span class="c1"># Instrument resolution</span>
            <span class="n">calculator_resolution</span> <span class="o">=</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">resolution</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createProjItemFromObj</span><span class="p">(</span><span class="n">Resolution</span><span class="o">.</span><span class="n">fromPars</span><span class="p">,</span>
                                                     <span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span>
                                                     <span class="p">[</span><span class="n">calculator_resolution</span><span class="o">.</span><span class="n">u</span><span class="p">,</span>
                                                      <span class="n">calculator_resolution</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
                                                      <span class="n">calculator_resolution</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                                                      <span class="n">calculator_resolution</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                                      <span class="n">calculator_resolution</span><span class="o">.</span><span class="n">y</span><span class="p">])</span>
            <span class="n">resolution</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_exp</span> <span class="o">+</span> <span class="s1">&#39;.resolution.u&#39;</span>
            <span class="n">resolution</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_exp</span> <span class="o">+</span> <span class="s1">&#39;.resolution.v&#39;</span>
            <span class="n">resolution</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_exp</span> <span class="o">+</span> <span class="s1">&#39;.resolution.w&#39;</span>
            <span class="n">resolution</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_exp</span> <span class="o">+</span> <span class="s1">&#39;.resolution.x&#39;</span>
            <span class="n">resolution</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_exp</span> <span class="o">+</span> <span class="s1">&#39;.resolution.y&#39;</span>

            <span class="c1"># Measured data points</span>
            <span class="n">x_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">ttheta</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">y_obs_up</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sy_obs_up</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">y_obs_down</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sy_obs_down</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">y_obs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sy_obs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">y_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">sy_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_sigma</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_up</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">y_obs_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_up</span><span class="p">)</span>
                <span class="n">sy_obs_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_up_sigma</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">y_obs_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_down</span><span class="p">)</span>
                <span class="n">sy_obs_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_down_sigma</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">y_obs</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_obs_up</span> <span class="o">+</span> <span class="n">y_obs_down</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">y_obs_up</span> <span class="o">=</span> <span class="n">y_obs_up</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">y_obs_down</span> <span class="o">=</span> <span class="n">y_obs_down</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">sy_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sy_obs_up</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sy_obs_down</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">MeasuredPattern</span><span class="p">(</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">sy_obs</span><span class="p">,</span> <span class="n">y_obs_up</span><span class="p">,</span> <span class="n">sy_obs_up</span><span class="p">,</span> <span class="n">y_obs_down</span><span class="p">,</span> <span class="n">sy_obs_down</span><span class="p">)</span>

            <span class="n">experiment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createProjItemFromObj</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">fromPars</span><span class="p">,</span>
                                                     <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;measured_pattern&#39;</span><span class="p">],</span>
                                                     <span class="p">[</span><span class="n">calculator_experiment_name</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">backgrounds</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">data</span><span class="p">])</span>

            <span class="c1"># Fix up phase scale, but it is a terrible way of doing things.....</span>
            <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">calculator_experiment_name</span><span class="p">]</span>
            <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">refine</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">refinement</span>
            <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;store&#39;</span><span class="p">][</span><span class="s1">&#39;hide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span>
                <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">constraint_flag</span>
            <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span>
                <span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_exp</span> <span class="o">+</span> <span class="s1">&#39;.phase.scale[0]&#39;</span>
            <span class="k">del</span> <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">calculator_experiment_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">item</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExperimentPhase</span><span class="o">.</span><span class="n">fromPars</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">item</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_exp</span> <span class="o">+</span> <span class="s1">&#39;.phase.scale[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">item</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">refine</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">refinement</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">item</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;store&#39;</span><span class="p">][</span><span class="s1">&#39;hide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">constraint_flag</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">item</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">label</span>
            <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_exp</span> <span class="o">+</span> <span class="s1">&#39;.setup.wavelength&#39;</span>
            <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="s1">&#39;mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping_exp</span> <span class="o">+</span> <span class="s1">&#39;.setup.offset_ttheta&#39;</span>

            <span class="n">experiments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

        <span class="c1"># logging.info(experiments)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">Experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getCalculations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Calculations</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="p">,</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">cl_rhochi</span><span class="o">.</span><span class="n">RhoChi</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Calculations</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">apply_constraint</span><span class="p">()</span>
        <span class="n">calculations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">calculator_experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
            <span class="n">calculator_experiment_name</span> <span class="o">=</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">data_name</span>
            <span class="n">calculator_experiment_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="p">)</span>

            <span class="c1"># Calculated data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;+++++++++&gt; start&quot;</span><span class="p">)</span>
            <span class="n">calculated_pattern</span><span class="p">,</span> <span class="n">calculated_bragg_peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">calc_profile</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">ttheta</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&lt;+++++++++ end&quot;</span><span class="p">)</span>

            <span class="c1"># Bragg peaks</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">calculator_experiment_index</span><span class="p">]</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">offset_ttheta</span>
            <span class="n">bragg_peaks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">phase_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">item</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">getCrystal</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">crystal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">crystal</span><span class="o">.</span><span class="n">data_name</span> <span class="o">==</span> <span class="n">phase_info</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">crystal</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="n">crystal</span> <span class="o">=</span> <span class="n">getCrystal</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">crystal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="n">bragg_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CrystalBraggPeaks</span><span class="p">(</span><span class="n">crystal</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
                                                     <span class="n">calculated_bragg_peaks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">index_h</span><span class="p">,</span>
                                                     <span class="n">calculated_bragg_peaks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">index_k</span><span class="p">,</span>
                                                     <span class="n">calculated_bragg_peaks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">index_l</span><span class="p">,</span>
                                                     <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                                         <span class="n">calculated_bragg_peaks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">ttheta</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
            <span class="n">bragg_peaks</span> <span class="o">=</span> <span class="n">BraggPeaks</span><span class="p">(</span><span class="n">bragg_peaks</span><span class="p">)</span>

            <span class="c1"># Calculated diffraction pattern</span>
            <span class="n">x_calc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculated_pattern</span><span class="o">.</span><span class="n">ttheta</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">y_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity</span><span class="p">)</span>
                <span class="n">sy_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_sigma</span><span class="p">)</span>
                <span class="c1">###y_calc = np.array(calculated_pattern.intensity_total)</span>
                <span class="n">y_calc_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculated_pattern</span><span class="o">.</span><span class="n">intensity_up_total</span><span class="p">)</span>
                <span class="c1">###y_calc_down = np.array(calculated_pattern.intensity_down_total)</span>
                <span class="n">y_calc</span> <span class="o">=</span> <span class="n">y_calc_up</span>  <span class="c1">###+ y_calc_down</span>
            <span class="k">elif</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_up</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">y_obs_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_up</span><span class="p">)</span>
                <span class="n">sy_obs_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_up_sigma</span><span class="p">)</span>
                <span class="n">y_obs_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_down</span><span class="p">)</span>
                <span class="n">sy_obs_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculator_experiment</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">intensity_down_sigma</span><span class="p">)</span>
                <span class="n">y_obs</span> <span class="o">=</span> <span class="n">y_obs_up</span> <span class="o">+</span> <span class="n">y_obs_down</span>
                <span class="n">sy_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sy_obs_up</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sy_obs_down</span><span class="p">))</span>
                <span class="n">y_calc_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculated_pattern</span><span class="o">.</span><span class="n">intensity_up_total</span><span class="p">)</span>
                <span class="n">y_calc_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calculated_pattern</span><span class="o">.</span><span class="n">intensity_down_total</span><span class="p">)</span>
                <span class="n">y_calc</span> <span class="o">=</span> <span class="n">y_calc_up</span> <span class="o">+</span> <span class="n">y_calc_down</span>
            <span class="n">y_obs_upper</span> <span class="o">=</span> <span class="n">y_obs</span> <span class="o">+</span> <span class="n">sy_obs</span>
            <span class="n">y_obs_lower</span> <span class="o">=</span> <span class="n">y_obs</span> <span class="o">-</span> <span class="n">sy_obs</span>
            <span class="n">y_diff_upper</span> <span class="o">=</span> <span class="n">y_obs</span> <span class="o">+</span> <span class="n">sy_obs</span> <span class="o">-</span> <span class="n">y_calc</span>
            <span class="n">y_diff_lower</span> <span class="o">=</span> <span class="n">y_obs</span> <span class="o">-</span> <span class="n">sy_obs</span> <span class="o">-</span> <span class="n">y_calc</span>

            <span class="n">limits</span> <span class="o">=</span> <span class="n">Limits</span><span class="p">(</span><span class="n">y_obs_lower</span><span class="p">,</span> <span class="n">y_obs_upper</span><span class="p">,</span> <span class="n">y_diff_upper</span><span class="p">,</span> <span class="n">y_diff_lower</span><span class="p">,</span> <span class="n">x_calc</span><span class="p">,</span> <span class="n">y_calc</span><span class="p">)</span>
            <span class="n">calculated_pattern</span> <span class="o">=</span> <span class="n">CalculatedPattern</span><span class="p">(</span><span class="n">x_calc</span><span class="p">,</span> <span class="n">y_calc</span><span class="p">,</span> <span class="n">y_diff_lower</span><span class="p">,</span> <span class="n">y_diff_upper</span><span class="p">)</span>

            <span class="n">calculations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Calculation</span><span class="p">(</span><span class="n">calculator_experiment_name</span><span class="p">,</span>
                                            <span class="n">bragg_peaks</span><span class="p">,</span> <span class="n">calculated_pattern</span><span class="p">,</span> <span class="n">limits</span><span class="p">))</span>
        <span class="n">calculations</span> <span class="o">=</span> <span class="n">Calculations</span><span class="p">(</span><span class="n">calculations</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">calculations</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">calculations</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_setCalculatorObjFromProjectDict</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">cl_fitable</span><span class="o">.</span><span class="n">Fitable</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Base</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">cl_fitable</span><span class="o">.</span><span class="n">Fitable</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">item</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">value</span>
        <span class="n">item</span><span class="o">.</span><span class="n">refinement</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">][</span><span class="s1">&#39;refine&#39;</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_createProjDictFromObj</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="s1">&#39;PathDict&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">cl_fitable</span><span class="o">.</span><span class="n">Fitable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; ... &quot;&quot;&quot;</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">cl_fitable</span><span class="o">.</span><span class="n">Fitable</span><span class="p">):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;constraint&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;hide&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setItemByPath</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;refine&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="CryspyCalculator.setPhases"><a class="viewcode-back" href="../../../../calculators.html#easyInterface.Diffraction.Calculators.CryspyCalculator.setPhases">[docs]</a>    <span class="k">def</span> <span class="nf">setPhases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phases</span><span class="p">:</span> <span class="n">Phases</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set phases (sample model tab in GUI)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-&gt; start&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phases</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addPhase</span><span class="p">(</span><span class="n">phases</span><span class="p">[</span><span class="n">phase_name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&lt;- end&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CryspyCalculator.setExperiments"><a class="viewcode-back" href="../../../../calculators.html#easyInterface.Diffraction.Calculators.CryspyCalculator.setExperiments">[docs]</a>    <span class="k">def</span> <span class="nf">setExperiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">:</span> <span class="n">Experiments</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set experiments (Experimental data tab in GUI)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-&gt; start&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">experiment_name</span> <span class="ow">in</span> <span class="n">experiments</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addExperiment</span><span class="p">(</span><span class="n">experiments</span><span class="p">[</span><span class="n">experiment_name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&lt;- end&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CryspyCalculator.setObjFromProjectDicts"><a class="viewcode-back" href="../../../../calculators.html#easyInterface.Diffraction.Calculators.CryspyCalculator.setObjFromProjectDicts">[docs]</a>    <span class="k">def</span> <span class="nf">setObjFromProjectDicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phases</span><span class="p">:</span> <span class="n">Phases</span><span class="p">,</span> <span class="n">experiments</span><span class="p">:</span> <span class="n">Experiments</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set all the cryspy parameters from project dictionary&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setPhases</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setExperiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span></div>

<div class="viewcode-block" id="CryspyCalculator.asCifDict"><a class="viewcode-back" href="../../../../calculators.html#easyInterface.Diffraction.Calculators.CryspyCalculator.asCifDict">[docs]</a>    <span class="k">def</span> <span class="nf">asCifDict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;...&quot;&quot;&quot;</span>
        <span class="n">experiments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">calculations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="p">,</span> <span class="n">cryspy</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">cl_rhochi</span><span class="o">.</span><span class="n">RhoChi</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">experiments</span> <span class="o">=</span> <span class="s2">&quot;data_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
                              <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">params_to_cif</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span>
                                  <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_to_cif</span><span class="p">()</span>  <span class="c1"># temporarily solution, as params_to_cif, data_to_cif and calc_to_cif are not implemented yet in cryspy 0.2.0</span>
                <span class="n">calculations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calc_to_cif</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_cif</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;phases&#39;</span><span class="p">:</span> <span class="n">phases</span><span class="p">,</span>
            <span class="s1">&#39;experiments&#39;</span><span class="p">:</span> <span class="n">experiments</span><span class="p">,</span>
            <span class="s1">&#39;calculations&#39;</span><span class="p">:</span> <span class="n">calculations</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="CryspyCalculator.refine"><a class="viewcode-back" href="../../../../calculators.html#easyInterface.Diffraction.Calculators.CryspyCalculator.refine">[docs]</a>    <span class="nd">@time_it</span>
    <span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;refinement ...&quot;&quot;&quot;</span>
        <span class="n">refinement_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">refine</span><span class="p">()</span>
        <span class="n">scipy_refinement_res</span> <span class="o">=</span> <span class="n">refinement_res</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">refinement_res</span><span class="p">,</span> <span class="n">scipy_refinement_res</span></div>

    <span class="k">def</span> <span class="nf">getChiSq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">chi_sq</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">n_res</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># TODO this is bull, why is it like this!!!! :-(</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">calculator_experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
                <span class="n">chi_sq</span><span class="p">,</span> <span class="n">n_res</span> <span class="o">=</span> <span class="n">calculator_experiment</span><span class="o">.</span><span class="n">calc_chi_sq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chi_sq</span><span class="p">,</span> <span class="n">n_res</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">final_chi_square</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">chi_sq</span><span class="p">,</span> <span class="n">n_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChiSq</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">chi_sq</span> <span class="o">/</span> <span class="n">n_res</span>

    <span class="k">def</span> <span class="nf">_mappedValueUpdater</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_str</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">aeval</span> <span class="o">=</span> <span class="n">Interpreter</span><span class="p">(</span><span class="n">usersyms</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">aeval</span><span class="p">(</span><span class="n">item_str</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_mappedRefineUpdater</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_str</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">aeval</span> <span class="o">=</span> <span class="n">Interpreter</span><span class="p">(</span><span class="n">usersyms</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">aeval</span><span class="p">(</span><span class="n">item_str</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">refinement</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">getProjectName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_rcif</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">getPhaseNames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>

    <span class="nd">@time_it</span>
    <span class="k">def</span> <span class="nf">addPhase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="n">Phase</span><span class="p">):</span>
        <span class="n">phase_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createPhaseObj</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase_obj</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase_obj</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="o">.</span><span class="n">data_name</span> <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">crystals</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">apply_constraint</span><span class="p">()</span>

    <span class="nd">@time_it</span>
    <span class="k">def</span> <span class="nf">addExperiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">):</span>
        <span class="n">exp_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createExperimentObj</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_obj</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_obj</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">experiment</span><span class="o">.</span><span class="n">data_name</span> <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_createPhaseObj</span><span class="p">(</span><span class="n">phase</span><span class="p">:</span> <span class="n">Phase</span><span class="p">):</span>
        <span class="n">this_cell</span> <span class="o">=</span> <span class="n">cpCell</span><span class="p">(</span><span class="n">length_a</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">][</span><span class="s1">&#39;length_a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                           <span class="n">length_b</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">][</span><span class="s1">&#39;length_b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                           <span class="n">length_c</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">][</span><span class="s1">&#39;length_c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                           <span class="n">angle_alpha</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">][</span><span class="s1">&#39;angle_alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                           <span class="n">angle_beta</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">][</span><span class="s1">&#39;angle_beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                           <span class="n">angle_gamma</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">][</span><span class="s1">&#39;angle_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">this_space_group</span> <span class="o">=</span> <span class="n">cpSpaceGroup</span><span class="p">(</span><span class="n">name_hm_alt</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;spacegroup&#39;</span><span class="p">][</span><span class="s1">&#39;space_group_name_HM_alt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">it_number</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;spacegroup&#39;</span><span class="p">][</span><span class="s1">&#39;space_group_IT_number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">it_coordinate_system_code</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;spacegroup&#39;</span><span class="p">][</span><span class="s1">&#39;origin_choice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">crystal_system</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;spacegroup&#39;</span><span class="p">][</span><span class="s1">&#39;crystal_system&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">this_atoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">this_adp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">this_msp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atomLabel</span> <span class="ow">in</span> <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;atoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;atoms&#39;</span><span class="p">][</span><span class="n">atomLabel</span><span class="p">]</span>
            <span class="n">this_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">AtomSite</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">atomLabel</span><span class="p">,</span> <span class="n">type_symbol</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;type_symbol&#39;</span><span class="p">],</span>
                         <span class="n">fract_x</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;fract_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">fract_y</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;fract_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                         <span class="n">fract_z</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;fract_z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                         <span class="n">occupancy</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;occupancy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">adp_type</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;adp_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                         <span class="n">u_iso_or_equiv</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;U_iso_or_equiv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="s1">&#39;ADP&#39;</span><span class="p">][</span><span class="s1">&#39;u_11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">this_adp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">AtomSiteAniso</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">atomLabel</span><span class="p">,</span> <span class="n">u_11</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;ADP&#39;</span><span class="p">][</span><span class="s1">&#39;u_11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                  <span class="n">u_22</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;ADP&#39;</span><span class="p">][</span><span class="s1">&#39;u_22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">u_33</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;ADP&#39;</span><span class="p">][</span><span class="s1">&#39;u_33&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                  <span class="n">u_12</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;ADP&#39;</span><span class="p">][</span><span class="s1">&#39;u_12&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">u_13</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;ADP&#39;</span><span class="p">][</span><span class="s1">&#39;u_13&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                  <span class="n">u_23</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;ADP&#39;</span><span class="p">][</span><span class="s1">&#39;u_23&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="s1">&#39;MSP&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">this_msp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">AtomSiteSusceptibility</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">atomLabel</span><span class="p">,</span> <span class="n">chi_type</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;MSP&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                           <span class="n">chi_11</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;MSP&#39;</span><span class="p">][</span><span class="s1">&#39;chi_11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                           <span class="n">chi_22</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;MSP&#39;</span><span class="p">][</span><span class="s1">&#39;chi_22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">chi_33</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;MSP&#39;</span><span class="p">][</span><span class="s1">&#39;chi_33&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                           <span class="n">chi_12</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;MSP&#39;</span><span class="p">][</span><span class="s1">&#39;chi_12&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">chi_13</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;MSP&#39;</span><span class="p">][</span><span class="s1">&#39;chi_13&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                           <span class="n">chi_23</span><span class="o">=</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;MSP&#39;</span><span class="p">][</span><span class="s1">&#39;chi_23&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">this_atoms</span> <span class="o">=</span> <span class="n">AtomSiteL</span><span class="p">(</span><span class="n">this_atoms</span><span class="p">)</span>
        <span class="n">this_adp</span> <span class="o">=</span> <span class="n">AtomSiteAnisoL</span><span class="p">(</span><span class="n">this_adp</span><span class="p">)</span>
        <span class="n">this_msp</span> <span class="o">=</span> <span class="n">AtomSiteSusceptibilityL</span><span class="p">(</span><span class="n">this_msp</span><span class="p">)</span>

        <span class="n">phase_obj</span> <span class="o">=</span> <span class="n">Crystal</span><span class="p">(</span><span class="n">data_name</span><span class="o">=</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;phasename&#39;</span><span class="p">],</span> <span class="n">cell</span><span class="o">=</span><span class="n">this_cell</span><span class="p">,</span> <span class="n">space_group</span><span class="o">=</span><span class="n">this_space_group</span><span class="p">,</span>
                            <span class="n">atom_site</span><span class="o">=</span><span class="n">this_atoms</span><span class="p">,</span>
                            <span class="n">atom_site_aniso</span><span class="o">=</span><span class="n">this_adp</span><span class="p">,</span> <span class="n">atom_site_susceptibility</span><span class="o">=</span><span class="n">this_msp</span><span class="p">)</span>
        <span class="n">phase_obj</span><span class="o">.</span><span class="n">apply_constraint</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">phase_obj</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_createExperimentObj</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">):</span>
        <span class="c1"># First create a background</span>
        <span class="n">backgrounds</span> <span class="o">=</span> <span class="n">PdBackgroundL</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="n">PdBackground</span><span class="p">(</span><span class="n">ttheta</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;ttheta&#39;</span><span class="p">],</span>
                                             <span class="n">intensity</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># backgrounds = PdBackgroundL(backgrounds)</span>
        <span class="c1"># Resolution</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="n">PdInstrResolution</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">][</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                       <span class="n">v</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">][</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                       <span class="n">w</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                       <span class="n">x</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                       <span class="n">y</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Measured pattern</span>
        <span class="n">pol</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">PdMeas</span><span class="p">(</span><span class="n">ttheta</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intensity</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">intensity_sigma</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                  <span class="n">intensity_up</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">intensity_up_sigma</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                  <span class="n">intensity_down</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">intensity_down_sigma</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>

        <span class="n">non_pol</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">PdMeas</span><span class="p">(</span><span class="n">ttheta</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intensity</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">intensity_sigma</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isPolarised</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">PdMeasL</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">pol</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                                                <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">][</span><span class="s1">&#39;y_obs&#39;</span><span class="p">],</span>
                                                <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">][</span><span class="s1">&#39;sy_obs&#39;</span><span class="p">],</span>
                                                <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">][</span><span class="s1">&#39;y_obs_up&#39;</span><span class="p">],</span>
                                                <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">][</span><span class="s1">&#39;sy_obs_up&#39;</span><span class="p">],</span>
                                                <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">][</span><span class="s1">&#39;y_obs_down&#39;</span><span class="p">],</span>
                                                <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">][</span><span class="s1">&#39;sy_obs_down&#39;</span><span class="p">]))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">PdMeasL</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">non_pol</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                                                    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">][</span><span class="s1">&#39;y_obs&#39;</span><span class="p">],</span>
                                                    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;measured_pattern&#39;</span><span class="p">][</span><span class="s1">&#39;sy_obs&#39;</span><span class="p">]))))</span>

        <span class="c1"># Associate it to a phase</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">PhaseL</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="n">cpPhase</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Setup the instrument...</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="n">Setup</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">offset_ttheta</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Pd</span><span class="p">(</span><span class="n">data_name</span><span class="o">=</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">background</span><span class="o">=</span><span class="n">backgrounds</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">meas</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                  <span class="n">phase</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">associatePhaseToExp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">cryspyPhase</span> <span class="o">=</span> <span class="n">cpPhase</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">exp_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">PhaseL</span><span class="p">([</span><span class="n">cryspyPhase</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">item</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Associated phase </span><span class="si">%s</span><span class="s1"> to experiment </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disassociatePhaseToExp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">exp_name</span><span class="p">)</span>
        <span class="n">exp_phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span>
        <span class="n">exp_phases</span> <span class="o">=</span> <span class="n">PhaseL</span><span class="p">(</span>
            <span class="p">[</span><span class="n">exp_phases</span><span class="o">.</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_phases</span><span class="o">.</span><span class="n">item</span><span class="p">)</span> <span class="k">if</span> <span class="n">exp_phases</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">phase_name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">exp_phases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Disassociated phase </span><span class="si">%s</span><span class="s1"> from experiment </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getPhasesAssocatedToExp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">exp_name</span><span class="p">)</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cryspy_obj</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span>
        <span class="c1"># THIS IS A HACK AS CRYSPY IS SGSHRGFHGHRTGYHT</span>
        <span class="n">exp_phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">phases</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">exp_phases</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019-2020, Simon Ward

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>